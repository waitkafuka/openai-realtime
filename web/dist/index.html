<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>OpenAI Realtime Voice Chat</title><style>body{display:flex;flex-direction:column;justify-content:flex-start;align-items:center;min-height:100vh;margin:0;background-color:#f0f0f0;font-family:Arial,sans-serif}.container{display:flex;flex-direction:column;align-items:center;width:100%;max-width:100%;padding:20px;box-sizing:border-box}#talkButton{width:260px;height:260px;border-radius:50%;background:linear-gradient(145deg,#f0f0ff,#d0d0ff);box-shadow:10px 10px 30px rgba(190,190,255,.5),-10px -10px 30px rgba(255,255,255,.8);border:none;outline:0;cursor:pointer;font-size:14px;color:#4a4a7f;transition:all .3s ease;-webkit-tap-highlight-color:transparent}#talkButton:active{box-shadow:inset 10px 10px 30px rgba(190,190,255,.5),inset -10px -10px 30px rgba(255,255,255,.8);color:#3a3a6f}#waveform{width:100%;height:80px;max-width:600px;background:linear-gradient(to bottom,rgba(240,240,255,.8),rgba(220,220,255,.8));margin-top:20px;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,.1)}#messageContainer{width:100%;max-width:600px;background:linear-gradient(to bottom,rgba(240,240,255,.8),rgba(220,220,255,.8));border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-top:20px;box-sizing:border-box;height:300px;overflow-y:auto;padding:10px}#textInput{width:100%;max-width:300px;height:80px;margin-top:20px;padding:10px;border:1px solid #ccc;border-radius:5px;resize:none;font-size:14px;box-sizing:border-box}#sendButton{margin-top:10px;padding:10px 20px;background-color:#4caf50;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:16px}#sendButton:hover{background-color:#45a049}.error-message,.message{margin-bottom:10px;padding:5px;border-radius:5px;white-space:pre-wrap;word-wrap:break-word;background-color:rgba(255,255,255,.7)}.error-message{background-color:rgba(255,235,238,.7);color:#d32f2f}.timestamp{font-size:.8em;color:#666;margin-right:5px}@media (max-width:600px){#talkButton{width:200px;height:200px;font-size:18px}#waveform{height:60px}#messageContainer{height:200px}#textInput{height:60px}#sendButton{font-size:14px;padding:8px 16px}}</style></head><body><div class="container"><canvas id="waveform"></canvas><div id="messageContainer"></div></div><div class="container"><button id="talkButton">按住说话</button><div style="display: none;"><textarea id="textInput" placeholder="输入文本消息..."></textarea> <button id="sendButton">发送</button></div></div><script>let audioContext,playbackDataArray,visualizerAnimationFrame,audioBufferQueue=[],isPlaying=!1,playbackAnalyser=null;function initAudioContext(){audioContext||(audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}))}function convertPCM16ToFloat32(e){for(var t=new Float32Array(e.length),n=0;n<e.length;n++){var o=e[n];t[n]=o/32768}return t}function createAudioBuffer(e,t,n,o){for(var a=t.length/o,r=e.createBuffer(o,a,n),i=0;i<o;i++)for(var s=r.getChannelData(i),c=0;c<a;c++)s[c]=t[c*o+i];return r}function playAudioFromBase64PCM16(e,t=24e3,n=1){initAudioContext();const o=base64ToArrayBuffer(e);const a=convertPCM16ToFloat32(new Int16Array(o)),r=createAudioBuffer(audioContext,a,t,n);audioBufferQueue.push(r),isPlaying||playNextAudioBuffer()}function playNextAudioBuffer(){if(0===audioBufferQueue.length)return isPlaying=!1,void stopVisualizer();isPlaying=!0;const e=audioBufferQueue.shift(),t=audioContext.createBufferSource();t.buffer=e,playbackAnalyser||(playbackAnalyser=audioContext.createAnalyser(),playbackAnalyser.fftSize=256,playbackDataArray=new Uint8Array(playbackAnalyser.frequencyBinCount)),t.connect(playbackAnalyser),playbackAnalyser.connect(audioContext.destination),t.onended=playNextAudioBuffer,t.start(0),visualizerAnimationFrame||drawPlaybackWaveform()}function drawPlaybackWaveform(){visualizerAnimationFrame=requestAnimationFrame(drawPlaybackWaveform),playbackAnalyser.getByteTimeDomainData(playbackDataArray),drawWaveform(playbackDataArray)}function stopVisualizer(){visualizerAnimationFrame&&(cancelAnimationFrame(visualizerAnimationFrame),visualizerAnimationFrame=null),playbackAnalyser=null,waveformCtx.clearRect(0,0,waveform.width,waveform.height)}const ws=new WebSocket("ws://localhost:3008");ws.onopen=function(){console.log("Connected to the server.")};let currentMessageElement=null;function base64ToArrayBuffer(e){const t=window.atob(e),n=t.length,o=new Uint8Array(n);for(let e=0;e<n;e++)o[e]=t.charCodeAt(e);return o.buffer}ws.onmessage=function(e){const t=JSON.parse(e.data);"audio"===t.type?(console.log("Received audio data:",t.audio.length),playAudioFromBase64PCM16(t.audio)):"text"===t.type?(console.log("Received text message:",t.content),appendMessage(t.content)):"error"===t.type?console.error("Server error:",t.message):"response.audio_transcript.done"===t.type&&finishCurrentMessage()};let processor,analyser,recording=!1;const button=document.getElementById("talkButton"),waveform=document.getElementById("waveform"),waveformCtx=waveform.getContext("2d");function startRecording(e){e.preventDefault(),recording||(recording=!0,button.textContent="松开发送",navigator.mediaDevices.getUserMedia({audio:!0}).then((function(e){initAudioContext();const t=audioContext.createMediaStreamSource(e);processor=audioContext.createScriptProcessor(2048,1,1),analyser=audioContext.createAnalyser(),analyser.fftSize=256;const n=analyser.frequencyBinCount,o=new Uint8Array(n);t.connect(analyser),analyser.connect(processor),processor.connect(audioContext.destination),processor.onaudioprocess=function(e){if(!recording)return;const t=base64EncodeAudio(e.inputBuffer.getChannelData(0));ws.send(JSON.stringify({type:"audio",audio:t})),analyser.getByteTimeDomainData(o),drawWaveform(o)}})).catch((function(e){console.log("Error: "+e)})))}function stopRecording(){recording&&(recording=!1,button.textContent="按住说话",processor&&(processor.disconnect(),processor=null),analyser&&(analyser.disconnect(),analyser=null),audioContext&&audioContext.close().then((()=>{audioContext=null,console.log("AudioContext has been closed.")})),ws.send(JSON.stringify({type:"audio_commit"})),waveformCtx.clearRect(0,0,waveform.width,waveform.height),console.log("Recording stopped and committed."))}function drawWaveform(e){const t=waveformCtx.createLinearGradient(0,0,0,waveform.height);t.addColorStop(0,"rgba(240, 240, 255, 0.8)"),t.addColorStop(1,"rgba(220, 220, 255, 0.8)"),waveformCtx.fillStyle=t,waveformCtx.fillRect(0,0,waveform.width,waveform.height);const n=waveformCtx.createLinearGradient(0,0,0,waveform.height);n.addColorStop(0,"rgba(0, 100, 255, 0.8)"),n.addColorStop(.5,"rgba(0, 150, 255, 0.6)"),n.addColorStop(1,"rgba(0, 200, 255, 0.4)"),waveformCtx.lineWidth=2,waveformCtx.strokeStyle=n,waveformCtx.beginPath();const o=1*waveform.width/e.length;let a=0;for(let t=0;t<e.length;t++){const n=e[t]/128*waveform.height/2;0===t?waveformCtx.moveTo(a,n):waveformCtx.lineTo(a,n),a+=o}waveformCtx.lineTo(waveform.width,waveform.height/2),waveformCtx.stroke()}function floatTo16BitPCM(e){const t=new ArrayBuffer(2*e.length),n=new DataView(t);for(let t=0;t<e.length;t++){let o=Math.max(-1,Math.min(1,e[t]));n.setInt16(2*t,o<0?32768*o:32767*o,!0)}return t}function base64EncodeAudio(e){const t=floatTo16BitPCM(e);let n="";const o=new Uint8Array(t);for(let e=0;e<o.byteLength;e++)n+=String.fromCharCode(o[e]);return btoa(n)}function resizeCanvas(){waveform.width=waveform.clientWidth,waveform.height=waveform.clientHeight}window.addEventListener("resize",resizeCanvas),resizeCanvas();const textInput=document.getElementById("textInput"),sendButton=document.getElementById("sendButton");function sendTextMessage(){const e=textInput.value.trim();e&&(ws.send(JSON.stringify({type:"text",content:e})),textInput.value="")}function appendMessage(e,t=!1){const n=document.getElementById("messageContainer");if(!currentMessageElement){currentMessageElement=document.createElement("div"),currentMessageElement.className=t?"error-message":"message";const e=(new Date).toLocaleTimeString(),o=document.createElement("span");o.className="timestamp",o.textContent=`[${e}] `,currentMessageElement.appendChild(o),n.appendChild(currentMessageElement)}const o=document.createElement("span");o.textContent=e,currentMessageElement.appendChild(o),n.scrollTop=n.scrollHeight}function finishCurrentMessage(){currentMessageElement=null}sendButton.addEventListener("click",sendTextMessage),button.addEventListener("mousedown",startRecording),button.addEventListener("mouseup",stopRecording),button.addEventListener("mouseleave",stopRecording),button.addEventListener("touchstart",startRecording),button.addEventListener("touchend",stopRecording),document.body.addEventListener("touchmove",(function(e){e.preventDefault()}),{passive:!1});</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?af396cec7dae400977b8dfde8ff1b9ef";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();</script></body></html>